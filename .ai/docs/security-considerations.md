# Security Considerations

**Version:** 1.0  
**Last Updated:** February 2026  

---

## 1. Authentication Security

### 1.1 Password Storage

- **Hashing Algorithm**: bcrypt with cost factor 12
- **Never store plaintext passwords**
- **Salt**: Automatically generated by bcrypt
- **Minimum Requirements**: 6-16 characters, alphanumeric

```typescript
// Example: Password hashing
const hash = await bcrypt.hash(password, 12)
const isValid = await bcrypt.compare(password, hash)
```

### 1.2 Session Management

| Setting | Value | Rationale |
|---------|-------|-----------|
| Session Strategy | JWT | Stateless, scalable |
| Cookie Flags | httpOnly, secure, sameSite=strict | XSS/CSRF protection |
| Session Duration | 30 days | Balance UX/security |
| Token Rotation | Enabled | Prevent session hijacking |

### 1.3 Password Reset Security

- **Token Generation**: Cryptographically secure random token
- **Token Expiry**: 1 hour validity
- **One-time Use**: Tokens invalidated after use
- **Rate Limiting**: 5 requests per hour per email
- **Admin Approval Flow**: Optional admin approval for reset

---

## 2. Authorization & Access Control

### 2.1 Role-Based Access Control (RBAC)

```
USER ──► PRO ──► ADMIN ──► SUPERADMIN
         │              │
         └──────────────┴───► CLIENT (separate permission)
```

### 2.2 Authorization Layers

1. **Middleware Layer**: Route protection based on role
2. **API Layer**: Endpoint authorization checks
3. **Service Layer**: Resource ownership verification
4. **Database Layer**: Query-level filtering

### 2.3 Permission Matrix

| Resource | USER | PRO | CLIENT | ADMIN | SUPERADMIN |
|----------|------|-----|--------|-------|------------|
| Own Images | R/W/D | R/W/D | - | R/W/D | R/W/D |
| Own Projects | - | CRUD | - | CRUD | CRUD |
| Own Albums | - | CRUD | - | CRUD | CRUD |
| Shared Projects | - | - | R | R | R/W/D |
| All Users | - | - | - | R | CRUD |
| System Settings | - | - | - | R | CRUD |
| Audit Logs | - | - | - | R | CRUD |

---

## 3. API Security

### 3.1 Input Validation

- **Library**: Zod for schema validation
- **Sanitization**: All user inputs sanitized
- **File Uploads**: 
  - File type validation (whitelist)
  - Size limits (max 50MB per file)
  - Filename sanitization (remove special chars)

```typescript
// Example: Input validation schema
const uploadSchema = z.object({
  file: z.instanceof(File).refine(
    (file) => file.size <= 50 * 1024 * 1024,
    "File size must be under 50MB"
  )
})
```

### 3.2 Rate Limiting

| Endpoint | Limit | Window |
|----------|-------|--------|
| `/api/auth/*` | 10 | 1 minute |
| `/api/upload` | 20 | 1 minute |
| `/api/images` | 100 | 1 minute |
| Public APIs | 30 | 1 minute |

### 3.3 CORS Configuration

```typescript
// next.config.js
module.exports = {
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          { key: 'Access-Control-Allow-Origin', value: 'same-origin' },
          { key: 'Access-Control-Allow-Methods', value: 'GET,POST,PUT,DELETE,OPTIONS' },
          { key: 'Access-Control-Allow-Headers', value: 'Content-Type, Authorization' },
        ],
      },
    ],
  },
}
```

---

## 4. Data Protection

### 4.1 Sensitive Data Handling

| Data Type | Storage | Exposure |
|-----------|---------|----------|
| Passwords | bcrypt hash | Never exposed |
| JWT Secrets | Env variable | Never in code/logs |
| API Keys | Env variable | Never in client bundle |
| Session Tokens | httpOnly cookie | Not accessible to JS |
| User Emails | Database | Admin only |

### 4.2 File Upload Security

- **Type Validation**: Magic number check + extension whitelist
- **Content Scanning**: (Future) Virus scanning
- **Storage**: Separate from web root
- **Path Traversal**: Prevented via sanitization

### 4.3 Database Security

- **Connection**: SSL/TLS required
- **Credentials**: Environment variables only
- **Prisma Client**: Generated at build time
- **SQL Injection**: Prevented via Prisma parameterized queries

---

## 5. Network Security

### 5.1 HTTPS/TLS

- **Enforcement**: HSTS header enabled
- **TLS Version**: 1.2 minimum
- **Certificate**: Let's Encrypt or purchased

### 5.2 Security Headers

| Header | Value | Purpose |
|--------|-------|---------|
| Strict-Transport-Security | max-age=31536000; includeSubDomains | Force HTTPS |
| X-Content-Type-Options | nosniff | Prevent MIME sniffing |
| X-Frame-Options | DENY | Prevent clickjacking |
| X-XSS-Protection | 1; mode=block | XSS filtering |
| Content-Security-Policy | default-src 'self' | Prevent XSS/injection |
| Referrer-Policy | strict-origin-when-cross-origin | Privacy |

### 5.3 Vercel Security

- **Vercel WAF**: Enabled by default
- **DDoS Protection**: Built-in
- **Bot Protection**: Automatic

---

## 6. Application Security

### 6.1 Authentication Bypass Prevention

- **Check**: All private routes validated
- **Check**: Middleware executes before all routes
- **Check**: API routes return 401/403 on auth failure

### 6.2 IDOR Prevention

- **Check**: All resource access verifies ownership
- **Check**: UUIDs used instead of sequential IDs
- **Check**: API returns 404 (not 403) for missing resources

### 6.3 CSRF Protection

- **Method**: Same-site cookies
- **Check**: Session cookie has sameSite=strict
- **Check**: State-changing operations use POST/PUT/DELETE

---

## 7. Infrastructure Security

### 7.1 Environment Variables

```bash
# Required
DATABASE_URL=postgresql://...
AUTH_SECRET=<32-char-random-string>
ADMIN_EMAIL=admin2@frame.app
ADMIN_PASSWORD=<strong-password>
SETUP_SECRET=<32-char-random-string>

# Optional (for cloud storage)
SUPABASE_URL=https://...
SUPABASE_SERVICE_ROLE_KEY=<key>
```

### 7.2 Secrets Management

- **Never commit**: `.env` files, keys, credentials
- **Use**: `.env.example` for template
- **Rotate**: Secrets periodically
- **Audit**: Access to production secrets

### 7.3 Deployment Security

1. Use Vercel's built-in security
2. Enable Vercel Authentication (pro)
3. Set up environment-specific secrets
4. Enable Vercel Analytics for monitoring

---

## 8. Compliance & Audit

### 8.1 Audit Logging

All significant actions are logged:

```typescript
// Logged events
- USER_LOGIN, USER_LOGOUT
- USER_PASSWORD_CHANGED
- PROJECT_CREATED, PROJECT_DELETED
- IMAGE_UPLOADED, IMAGE_DELETED
- SHARE_LINK_CREATED
- ADMIN actions
```

### 8.2 Log Retention

- **Active Logs**: 90 days in database
- **Archived Logs**: 1 year in cold storage
- **Log Format**: Structured JSON for searchability

---

## 9. Security Checklist

### Development

- [ ] All inputs validated with Zod
- [ ] No sensitive data in logs
- [ ] Passwords hashed with bcrypt
- [ ] Session cookies httpOnly + secure
- [ ] Authorization checks on all endpoints

### Deployment

- [ ] HTTPS enforced
- [ ] Security headers configured
- [ ] Environment variables set
- [ ] Secrets not committed
- [ ] CORS configured

### Production

- [ ] Monitor failed login attempts
- [ ] Review audit logs regularly
- [ ] Rotate secrets periodically
- [ ] Backup database securely
- [ ] Test authentication flow

---

## 10. Known Security Gaps (Phase 7)

| Issue | Severity | Fix |
|-------|----------|-----|
| RLS not enabled on Supabase | HIGH | Enable in Phase 7 |
| No rate limiting middleware | MEDIUM | Add in Phase 7 |
| No IP allowlisting | LOW | Add if needed |
| No 2FA | MEDIUM | Future enhancement |

---

## 11. Security Incident Response

### If Security Breach Detected

1. **Isolate**: Take affected systems offline
2. **Assess**: Determine scope of breach
3. **Notify**: Alert affected users (GDPR)
4. **Remediate**: Fix vulnerability
5. **Review**: Update security measures
6. **Document**: Incident report

### Contact

- **Security Contact**: admin2@frame.app
- **Emergency**: Implement emergency shutdown procedure

---

*Last Updated: February 2026*
